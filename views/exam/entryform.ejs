<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entry form</title>
</head>
<body>
<!-- section to choose class -->
 <center>Choose class,sectionn and terminal for marks entry</center>
  <select name="subject" id="subject">
    <option value="">Choose subject</option>
    <% uniqueSubjects = new Set(subjects.map((subject)=>subject.newsubject)) %>
    <%uniqueSubjects.forEach((subject)=>{%>
      <option value="<%=subject%>"><%=subject%></option>
    <%})%>
    <option value=""></option>
  </select>
  <select name="classSection" id="classSection">
    <option value="" selected disabled>choose class & section</option>
<% studentClassdata.forEach((data)=>{%>
  <option value="<%=data.studentClass%>-<%=data.section%>"><%=data.studentClass%>-<%=data.section%></option>
<%})%>

  </select>
  <select name="terminals" id="terminal">
    <option value="" selected disabled>Choose Terminal</option>
    <%terminals.forEach((terminal)=>{%>
      <option value="<%=terminal.terminal%>"><%=terminal.terminal%></option>
   <% }) %>
  </select>
   <select name="academicYear" id="academicYear">
    <option value="" selected disabled>Choose academicYear</option>
    <%terminals.forEach((terminal)=>{%>
      <option value=""><%=terminal.terminal%></option>
   <% }) %>
  </select>
  <button onclick="loadform()">Load Form</button>




  <script>
    function loadform()
    {
        const selectedSubject = document.getElementById('subject').value;
        const classSection = document.getElementById('classSection').value
        const studentClass = classSection.split("-")[0];
        const section = classSection.split("-")[1];
        const academicYear = document.getElementById('academicYear').value;
        const terminal = document.getElementById('terminal').value

        window.location.href=(`/entryform?studentClass=${studentClass}&section=${section}&subject=${selectedSubject}&terminal=${terminal}&academicYear=${academicYear}`)
      
    }
  </script>
  <!-- end here -->

  <center>Enter Data</center>

  <form action="/entryform?<%= `studentClass=${studentClass}&section=${section}&subject=${subject}&academicYear=${academicYear}&terminal=${terminal}` %>" method="POST">
    
    <table cellspacing="0" border="1">
      <tr>
        <th>Reg</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Photo</th>
        <th>Th Marks (<%=subjectData[0].theory%>)</th>
        <th>Pr marks(<%=subjectData[0].practical*0.72%>)</th>
        <th>Attendance</th>
        <th>Attendance Marks</th>
        <th>Terminal Marks</th>
        
        <th>Total</th>
      </tr>
      <% studentData.forEach((student,idx)=>{%>
      
        <tr>
          <td><input type="text" name="reg[<%=student.reg%>]" value="<%=student.reg%>" readonly ></td>
          <td><input type="text" name="roll[<%=student.reg%>]" value="<%=student.roll%>" readonly ></td>
         <td><input type="text" name="name[<%=student.reg%>]" value="<%=student.name%>" readonly ></td>
          <td><img src="/student.png" alt="photo"></td>
          <td><input type="number" id="theorymarks" name="theorymarks[<%=student.reg%>]" value="" data-reg="<%= student.reg %>" min="0" max="<%=subjectData[0].theory%>"  oninput="this.value = Math.min(this.value, <%= subjectData[0].theory %>)"></td>
           <td><input type="number" data-reg="<%= student.reg %>"  id="practicalmarks" name="practicalmarks[<%=student.reg%>]" value="" oninput="this.value = Math.min(this.value, <%= subjectData[0].practical*0.72 %> )" min="0"></td>
          <td><input type="number" id="attendance" name="attendance[<%=student.reg%>]" value="" data-reg="<%= student.reg %>"></td>
          <td><input type="number" id="attendancemarks_<%=student.reg%>" name="attendanceMarks[<%=student.reg%>]" readonly></td>
          <td><input type="number" id="terminalmarks_<%=student.reg%>" name="terminalmarks[<%=student.reg%>]" readonly></td>
            <td><input type="number" id="totalpractical" name="totalpracticalmarks[<%=student.reg%>]" data-reg="<%=student.reg%>" readonly></td>
         

        </tr>

      <%})%>
    </table>
    <input type="submit" value="Save">
    <input type="hidden" id="terminal" name="terminal" value="<%=terminal%>">
     <input type="hidden" name="theoryfullmarks" id="fullMarks" value="<%=subjectData[0].theory%>">
     <input type="hidden" name="passMarks" id="passMarks" value="<%=subjectData[0].passingMarks%>">
     <input type="hidden" name="practicalfullmarks" id="practicalfullmarks" value="<%=subjectData[0].practical%>">
     <input type="hidden" name="creditHour" id="creditHour" value="<%=subjectData[0].creditHour %>">

  </form>

  <script>
    const terminal = document.getElementById('terminal').value;

if(terminal!="FINAL")
{
  const fullMarks = parseFloat(document.getElementById('fullMarks').value)
  document.querySelectorAll("#theorymarks").forEach((input)=>
{
  input.addEventListener("input",function (){
    const reg = this.dataset.reg;
    const theory = this.value || 0
   const terminalMarks =  document.getElementById(`terminalmarks_${reg}`).value=((theory/fullMarks)*10).toFixed(2)


  })
});
  document.querySelectorAll("#attendance").forEach((input)=>
{
  input.addEventListener("input",function (){
    const reg = this.dataset.reg;
    const attendanceDays = this.value || 0
    const workingDays = 120;
    attendancePercent = (attendanceDays/workingDays)*100;
    if(attendancePercent>=90 && attendancePercent<=100)
    {
      

      if(fullMarks<=25)
      {
        document.getElementById(`attendancemarks_${reg}`).value=2;
      }
      else if(fullMarks>25)
      {
      document.getElementById(`attendancemarks_${reg}`).value=4;
       }
   }
    else if(attendancePercent>=80 && attendancePercent<=89)
    {
      if(fullMarks<=25)
      {
        document.getElementById(`attendancemarks_${reg}`).value=1.5;
      }
      else if(fullMarks>25)
      {
      document.getElementById(`attendancemarks_${reg}`).value=3;
    }
  }
    else if(attendancePercent>=70 && attendancePercent<=79)
    {
      if(fullMarks<=25)
      {
        document.getElementById(`attendancemarks_${reg}`).value=1;
      }
      else if(fullMarks>25)
      {
      document.getElementById(`attendancemarks_${reg}`).value=2;
    }
    }
    else if(attendancePercent>=60 && attendancePercent<=69)
    {
      if(fullMarks<=25)
      {
        document.getElementById(`attendancemarks_${reg}`).value=0.5;
      }
      else if(fullMarks>25)
      {
      document.getElementById(`attendancemarks_${reg}`).value=1;
    }
  }
    else
    {
      document.getElementById(`attendancemarks_${reg}`).value=0;
    }

     //total calculation
     document.querySelectorAll("#totalpractical").forEach((input, idx) => { 
    
    const reg = input.dataset.reg;

    const theory = parseFloat(document.querySelectorAll('#theorymarks')[idx].value) || 0;
    const practicalmarks = parseFloat(document.querySelectorAll('#practicalmarks')[idx].value) || 0;
    const attendanceMarks = parseFloat(document.getElementById(`attendancemarks_${reg}`).value) || 0;


    // terminal marks calculate
    if(fullMarks<=25)
    {
      const terminalMarks = ((theory / fullMarks) * 5);
      document.getElementById(`terminalmarks_${reg}`).value = terminalMarks.toFixed(2);
    }
    else if(fullMarks>25)
    {
      const terminalMarks = ((theory / fullMarks) * 10);
      document.getElementById(`terminalmarks_${reg}`).value = terminalMarks.toFixed(2);
    }
   
const terminalMarks = parseFloat(document.getElementById(`terminalmarks_${reg}`).value) || 0;
    // total practical = theory + attendance + terminal + practical
    const total =  attendanceMarks + terminalMarks + practicalmarks;

    input.value = total.toFixed(2);
});

} 
)
});


}
async function populateData(subject,studentClass,section,academicYear,terminal)
{
  const data = await fetch(`/getPreviousmarks?subject=${subject}&studentClass=${studentClass}&section=${section}&academicYear=${academicYear}&terminal=${terminal}`);
  const result = await data.json();

  const attendanceData = await fetch(`/getAttendanceData?subject=${subject}&studentClass=${studentClass}&section=${section}&academicYear=${academicYear}&terminal=${terminal}`);
  const attendanceResult = await attendanceData.json();
if(result.length>0)
{
  result.forEach((item)=>
  {
    const reg = item.reg;
    document.querySelector(`input[name="theorymarks[${reg}]"]`).value=item.theorymarks;
    document.querySelector(`input[name="practicalmarks[${reg}]"]`).value=item.practicalmarks;
    document.querySelector(`input[name="attendance[${reg}]"]`).value=item.attendance;
    
    // Trigger input events to recalculate marks
    document.querySelector(`input[name="theorymarks[${reg}]"]`).dispatchEvent(new Event('input'));
    document.querySelector(`input[name="attendance[${reg}]"]`).dispatchEvent(new Event('input'));
  });
}
else
{
  console.log("No previous data found");
}
if(attendanceResult.length>0)
{
  attendanceResult.forEach((item)=>
  {
    const reg = item.reg;
    document.querySelector(`input[name="attendance[${reg}]"]`).value=item.attendance;
    
    // Trigger input events to recalculate marks
    document.querySelector(`input[name="attendance[${reg}]"]`).dispatchEvent(new Event('input'));
  });
}
else
{
  console.log("No attendance data found");
}
}






 window.onload = function() {
const urlParams = new URLSearchParams(window.location.search);

// Fetch each parameter
const studentClass = urlParams.get('studentClass');   // "7"
const section = urlParams.get('section');             // "x"
const subject = urlParams.get('subject');             // "COMPUTER"
const terminal = urlParams.get('terminal');           // "THIRD-2082"
const academicYear = urlParams.get('academicYear');   // "" (empty string in your example)
    populateData(subject,studentClass,section,academicYear,terminal) // pass the subject here
  }


  </script>


<script>
function calculateTotal(reg) {
    const fullMarks = parseFloat(document.getElementById('fullMarks').value);

    const theory = parseFloat(document.querySelector(`input[name="theorymarks[${reg}]"]`).value) || 0;
    const practical = parseFloat(document.querySelector(`input[name="practicalmarks[${reg}]"]`).value) || 0;
    const attendanceMarks = parseFloat(document.getElementById(`attendancemarks_${reg}`).value) || 0;

    // Calculate terminal marks
    let terminalMarks = 0;
    if(fullMarks <= 25){
        terminalMarks = (theory / fullMarks) * 5;
    } else {
        terminalMarks = (theory / fullMarks) * 10;
    }
    document.getElementById(`terminalmarks_${reg}`).value = terminalMarks.toFixed(2);

    // Total = practical + attendance + terminal
    const total = practical + attendanceMarks + terminalMarks;
    document.querySelector(`input[name="totalpracticalmarks[${reg}]"]`).value = total.toFixed(2);
}
document.querySelectorAll('#practicalmarks').forEach((input) => {
    input.addEventListener("input", function () {
        const reg = this.dataset.reg;
        calculateTotal(reg);
    });
});


</script>

</body>
</html>