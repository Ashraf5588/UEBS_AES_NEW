<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Admit Card</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#e5e7eb;padding:20px 0}
    
    .form-selector-panel{background:#fff;border-radius:10px;padding:20px;margin:0 auto 20px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:900px}
    .form-selector-container{display:flex;flex-direction:column;gap:15px}
    .form-selector-title{font-size:18px;font-weight:700;color:#1a3a52;text-align:center;text-transform:uppercase;letter-spacing:.5px}
    .form-selector-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .form-selector-grid select{width:100%;padding:10px 14px;border:2px solid #e1e8ed;border-radius:6px;font-size:14px;color:#2d3748;background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231a3a52' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center/16px;padding-right:35px;transition:border .2s;cursor:pointer;appearance:none}
    .form-selector-grid select:hover{border-color:#ff8c42}
    .form-selector-grid select:focus{outline:0;border-color:#ff8c42;box-shadow:0 0 0 3px rgba(255,140,66,.1)}
    .form-selector-container button{padding:12px 28px;background:linear-gradient(135deg,#ff8c42 0%,#e67a2e 100%);color:#fff;border:0;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 3px 12px rgba(255,140,66,.3);text-transform:uppercase;letter-spacing:.5px}
    .form-selector-container button:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(255,140,66,.4)}
    
    .action-buttons{max-width:900px;margin:0 auto 15px;display:flex;gap:10px;justify-content:center;background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .action-buttons button{padding:10px 24px;border:0;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.5px}
    .btn-print{background:linear-gradient(135deg,#1a3a52 0%,#2c5f8d 100%);color:#fff;box-shadow:0 3px 12px rgba(26,58,82,.3)}
    .btn-print:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(26,58,82,.4)}
    .btn-pdf{background:linear-gradient(135deg,#e53e3e 0%,#c53030 100%);color:#fff;box-shadow:0 3px 12px rgba(229,62,62,.3)}
    .btn-pdf:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(229,62,62,.4)}
    
    .page{width:210mm;min-height:297mm;margin:0 auto 20mm;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);padding:8mm;page-break-after:always}
    .admit-card{border:2px solid #1a3a52;border-radius:8px;padding:8px;margin-bottom:5mm;height:calc((297mm - 16mm - 10mm) / 3);display:flex;flex-direction:column;background:#fff;position:relative}
    .admit-card:last-child{margin-bottom:0}
    
    .card-header{display:flex;align-items:center;gap:10px;border-bottom:2px solid #ff8c42;padding-bottom:6px;margin-bottom:8px}
    .logo-section{width:50px;height:50px;border:2px solid #1a3a52;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;flex-shrink:0}
    .logo-section img{max-width:100%;max-height:100%;object-fit:contain}
    .school-info{flex:1}
    .school-name{font-size:13px;font-weight:800;color:#1a3a52;letter-spacing:.3px;line-height:1.2}
    .school-meta{font-size:8px;color:#4a5568;margin-top:2px;line-height:1.3}
    .card-title{font-size:11px;font-weight:700;color:#fff;background:linear-gradient(135deg,#1a3a52 0%,#2c5f8d 100%);padding:4px 10px;border-radius:4px;text-align:center;text-transform:uppercase;letter-spacing:.5px}
    
    .card-body{display:flex;gap:10px;flex:1;flex-direction:column}
    .top-section{display:flex;gap:10px}
    .student-info{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:5px 10px;font-size:9px}
    .info-item{display:flex;gap:5px}
    .info-label{font-weight:700;color:#4a5568;min-width:70px}
    .info-value{color:#1a3a52;font-weight:600}
    
    .photo-qr-section{display:flex;flex-direction:column;gap:8px;align-items:center;width:80px;flex-shrink:0}
    .student-photo{width:75px;height:85px;border:2px solid #1a3a52;border-radius:6px;object-fit:cover;background:#f8f9fa}
    .qr-code{width:75px;height:75px;border:1px solid #e1e8ed;border-radius:4px;display:flex;align-items:center;justify-content:center;background:#fff}
    .qr-code canvas{max-width:100%;max-height:100%}
    
    .routine-qr-section{display:flex;gap:10px;align-items:flex-start}
    .routine-table-container{flex:1}
    .routine-table{width:100%;border-collapse:collapse;font-size:8px}
    .routine-table th,.routine-table td{border:1px solid #cbd5e1;padding:3px 6px;text-align:left}
    .routine-table th{background:#1a3a52;color:#fff;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
    .routine-table td{background:#fafbfc;color:#1a3a52}
    
    .card-footer{border-top:1px solid #e1e8ed;padding-top:6px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;font-size:8px}
    .signature-line{text-align:center;flex:0}
    .signature-label{color:#4a5568;margin-top:18px;border-top:1px solid #1a3a52;padding-top:2px;font-weight:600;min-width:100px}
    
    @media print{
      body{background:#fff;padding:0;margin:0}
      .form-selector-panel,.no-print,.action-buttons{display:none!important}
      .page{box-shadow:none;margin:0;padding:8mm;page-break-after:always;min-height:297mm}
      .page:last-child{page-break-after:auto}
      .admit-card{page-break-inside:avoid;border:2px solid #1a3a52;border-radius:8px;height:calc((297mm - 16mm - 10mm) / 3);margin-bottom:5mm}
      .admit-card:last-child{margin-bottom:0}
    }
    @page{size:A4;margin:0}
    
    @media(max-width:900px){
      .page{width:100%;min-height:auto;padding:15px}
      .admit-card{height:auto;min-height:250px}
      .card-body{flex-direction:column}
      .photo-qr-section{flex-direction:row;width:100%;justify-content:center}
      .student-info{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="form-selector-panel no-print">
    <div class="form-selector-container">
      <div class="form-selector-title">Choose Class, Section and Terminal for Marks Entry</div>
      <div class="form-selector-grid">
        <select name="classSection" id="classSection">
          <option value="" selected disabled>Choose Class </option>
          <% uniqueClasses = new Set(studentClassdata.map(data => data.studentClass)); %>
          <% uniqueClasses.forEach((cls) => { %>
            <option value="<%=cls%>"><%=cls%></option>
          <% }) %>
        </select>

      <select name="terminals" id="terminal">
          <option value="" selected disabled>Choose Terminal</option>
          <% marksheetSetups[0].terminals.forEach((terminal)=>{%>
            <option value="<%=terminal.name%>"><%=terminal.name%></option>
          <% }) %>
        </select>

         <select name="academicYear" id="academicYear">
          <option value="" selected disabled>Choose Academic Year</option>
          <% currentYear = Number(marksheetSetups[0].academicYear) %>;
            <% for (let i = 0; i < 5; i++) { %>
              <option value="<%= currentYear - i %>"><%= currentYear - i %></option>
            <% } %>
        </select>
      </div>
      <button onclick="loadform()">Generate</button>
    </div>
  </div>


<% if(studentRecords && studentRecords.length > 0) { %>
  <div class="action-buttons no-print">
    <button class="btn-print" onclick="window.print()">Print All</button>
    <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
  </div>
  
  <% const schoolData = marksheetSetups[0] || {}; %>
  <% const terminalData = schoolData.terminals?.find(t => t.name === terminal) || {}; %>
  <% 
    let cardsPerPage = 3;
    let pageCount = Math.ceil(studentRecords.length / cardsPerPage);
  %>
  
  <% for(let pageIdx = 0; pageIdx < pageCount; pageIdx++) { %>
    <div class="page">
      <% 
        let startIdx = pageIdx * cardsPerPage;
        let endIdx = Math.min(startIdx + cardsPerPage, studentRecords.length);
        let pageStudents = studentRecords.slice(startIdx, endIdx);
      %>
      
      <% pageStudents.forEach((student, idx) => { %>
        <div class="admit-card">
          <div class="card-header">
            <div class="logo-section">
              <img src="<%= schoolData.logo || '/image.png' %>" alt="Logo" onerror="this.style.display='none'">
            </div>
            <div class="school-info">
              <div class="school-name"><%= schoolData.schoolName || 'School Name' %></div>
              <div class="school-meta">
                <%= schoolData.address || 'School Address' %> | 
                Phone: <%= schoolData.phone || 'N/A' %> | 
                <%= schoolData.website || '' %>
              </div>
            </div>
            <div class="card-title">Admit Card</div>
          </div>
          
          <div class="card-body">
            <div class="top-section">
              <div class="student-info">
                <div class="info-item">
                  <span class="info-label">Student Name:</span>
                  <span class="info-value"><%= student.name %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">Roll Number:</span>
                  <span class="info-value"><%= student.roll %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">Class:</span>
                  <span class="info-value"><%= student.studentClass %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">Section:</span>
                  <span class="info-value"><%= student.section %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">Reg. Number:</span>
                  <span class="info-value"><%= student.reg || 'N/A' %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">Terminal:</span>
                  <span class="info-value"><%= terminal %></span>
                </div>
                <div class="info-item" style="grid-column:1/-1">
                  <span class="info-label">Academic Year:</span>
                  <span class="info-value"><%= academicYear %></span>
                </div>
              </div>
              
              <div class="photo-qr-section">
                <img class="student-photo" src="<%= student.photo || '/default-avatar.png' %>" alt="Photo" onerror="this.style.display='none'">
              </div>
            </div>
            
            <div class="routine-qr-section">
              <div class="routine-table-container">
                <table class="routine-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Subject</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% examRoutines.forEach((routine) => { %>
                      <tr>
                        <td><%= routine.nepalidate %></td>
                        <td><%= routine.subject %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
              <% 
                const qrText = `${student.name}|${student.roll}|${student.studentClass}-${student.section}|${student.reg || 'N/A'}|${terminal}|${academicYear}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=75x75&data=${encodeURIComponent(qrText)}&color=1a3a52&bgcolor=ffffff`;
              %>
              <div class="qr-code">
                <img src="<%= qrUrl %>" alt="QR Code" style="width:75px;height:75px;display:block">
              </div>
            </div>
          </div>
          
          <div class="card-footer">
            <div class="signature-line">
              <div class="signature-label">Exam Coordinator</div>
            </div>
            <div class="signature-line">
              <div class="signature-label">Principal</div>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script>
    function downloadPDF() {
      const filename = 'Admit_Cards_<%= studentClass || "" %>_<%= terminal || "" %>_<%= academicYear || "" %>.pdf';
      const pages = document.querySelectorAll('.page');
      
      document.querySelectorAll('.no-print, .action-buttons').forEach(el => el.style.display = 'none');
      
      const opt = {
        margin: 0,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      
      const element = document.createElement('div');
      pages.forEach(page => {
        element.appendChild(page.cloneNode(true));
      });
      
      html2pdf().set(opt).from(element).save().then(() => {
        document.querySelectorAll('.no-print, .action-buttons').forEach(el => el.style.display = '');
      });
    }
  </script>
<% } %>

  <script>
    function loadform()
    {
       
        const classSection = document.getElementById('classSection').value
        const studentClass = classSection.split("-")[0];
        const section = classSection.split("-")[1];
        const academicYear = document.getElementById('academicYear').value;
        const terminal = document.getElementById('terminal').value

        window.location.href=(`/admitcard?studentClass=${studentClass}&section=${section}&terminal=${terminal}&academicYear=${academicYear}`)
      
    }
  </script>
</body>
</html>