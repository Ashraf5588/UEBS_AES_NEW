<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta charset="UTF-8">
<title>Grade Sheet</title>

<style>
    /* Clean, professional marksheet styling for A4 printing */
    :root{
      --accent:#1f6fb3;
      --muted:#666;
      --border:#222;
    }

    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:#f3f4f6;
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      color:#111;
    }

    .no-print{padding:18px;text-align:left}

    .control-panel{max-width:1100px;margin:12px auto;display:flex;gap:8px;align-items:center}
    .control-panel button{padding:8px 14px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .control-panel button.secondary{background:#6c757d}
    .control-panel .hint{color:var(--muted);font-size:13px;margin-left:8px}

    .sheet{
      width:210mm;
      min-height:auto;
      max-height:297mm;
      margin:18mm auto;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      padding:18mm;
      position:relative;
      box-sizing:border-box;
      page-break-after:always;
      border:1px solid #e2e8f0;
      page-break-inside:avoid;
    }

    /* Watermark centered, covers large area but subtle */
    .watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:0;opacity:0.06;pointer-events:none;display:flex;align-items:center;justify-content:center}
    .watermark img{max-width:480px;max-height:480px;opacity:0.08;filter:grayscale(100%)}

    .content{position:relative;z-index:1}

    .header{display:flex;gap:12px;align-items:center;border-bottom:2px solid var(--border);padding-bottom:10px}
    .logo{width:90px;height:90px;flex:0 0 90px;border-radius:8px;overflow:hidden;border:1px solid #ddd;background:#fff;display:flex;align-items:center;justify-content:center}
    .logo img{max-width:100%;max-height:100%;display:block}
    .head-text{flex:1}
    .school-name{font-size:20px;font-weight:800;letter-spacing:0.4px}
    .school-meta{font-size:12px;color:var(--muted);margin-top:4px}
    .report-title{text-align:right;font-weight:700;color:var(--accent)}

    .student-info{display:grid;grid-template-columns:1fr 1fr;margin-top:14px;gap:6px;font-size:13px}
    .info-label{font-weight:700;color:var(--muted);min-width:120px}
    .info-value{font-weight:600}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
    table th, table td{border:1px solid #cbd5e1;padding:8px;text-align:center}
    table th{background:#0b63a8;color:#fff;font-weight:700;font-size:12px}
    tr:nth-child(even) td{background:#fbfdff}
    .subject{text-align:left;padding-left:10px}

    .summary{display:flex;justify-content:space-between;margin-top:12px;font-weight:700}

    .remark-box{margin-top:12px;padding:10px;border:1px dashed #cbd5e1;background:#fbfcff}

    .sign-row{display:flex;justify-content:space-between;margin-top:26px}
    .sign{width:30%;text-align:center}
    .sign .line{margin-top:46px;border-top:1px solid #111;padding-top:6px;font-weight:700}

    .grading-scale{margin-top:18px;font-size:12px}
    .grading-scale td{Padding:6px}

    /* Print rules */
    @media print{
      body,html{background:#fff;margin:0;padding:0}
      .no-print{display:none !important}
      .sheet{box-shadow:none;margin:0;padding:12mm;width:210mm;min-height:auto;page-break-after:always;page-break-inside:avoid}
      .sheet:last-child{page-break-after:auto}
      .sheet .watermark{opacity:0.06}
    }

    @page{size:A4;margin:0}

    /* Form Selector Styling */
    .form-selector-panel {
      background: linear-gradient(135deg, #ff9d41 0%, #e7b170 100%);
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-selector-container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .form-selector-title {
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
    }

    .form-selector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-selector-panel select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      color: #333;
      background-color: #fff;
      transition: all 0.3s ease;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px;
      padding-right: 40px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .form-selector-panel select:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }

    .form-selector-panel select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-selector-panel button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      padding: 14px 32px;
      background: linear-gradient(135deg, #250789 0%, #1e096f 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-selector-panel button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .form-selector-panel button:active {
      transform: translateY(0);
    }

    @media print {
      .form-selector-panel {
        display: none !important;
      }
    }

</style>

</head>
<body>

  <div class="form-selector-panel no-print">
    <div class="form-selector-container">
      <div class="form-selector-title">Choose Class, Section and Terminal for Marksheet</div>
      <div class="form-selector-grid">
        <select name="classSection" id="classSection">
          <option value="" selected disabled>Choose Class & Section</option>
          <% studentClassdata.forEach((data)=>{%>
            <option value="<%=data.studentClass%>-<%=data.section%>"><%=data.studentClass%>-<%=data.section%></option>
          <%})%>
        </select>
 <select name="terminals" id="terminal">
          <option value="" selected disabled>Choose Terminal</option>
          <% marksheetSetups[0].terminals.forEach((terminal)=>{%>
            <option value="<%=terminal.name%>"><%=terminal.name%></option>
          <% }) %>
        </select>

        <select name="academicYear" id="academicYear">
          <option value="" selected disabled>Choose Academic Year</option>
          <% currentYear = Number(marksheetSetups[0].academicYear) %>;
            <% for (let i = 0; i < 5; i++) { %>
              <option value="<%= currentYear - i %>"><%= currentYear - i %></option>
            <% } %>
        </select>
      </div>
      <button onclick="loadform()">Load Marksheet</button>
    </div>
  </div>




  <script>
    function loadform()
    {
       
        const classSection = document.getElementById('classSection').value
        const studentClass = classSection.split("-")[0];
        const section = classSection.split("-")[1];
        const academicYear = document.getElementById('academicYear').value;
        const terminal = document.getElementById('terminal').value

        window.location.href=(`/generatemarksheet?studentClass=${studentClass}&section=${section}&format=${"practicalonly"}&terminal=${terminal}&academicYear=${academicYear}`)
      
    }
  </script>

    <div class="no-print control-panel">
        <button onclick="window.print()">Print All</button>
        <button onclick="downloadPdf()">Download PDF</button>
        <button onclick="exportToWord()" class="secondary">Download Word</button>
       
    </div>

    <input type="hidden" id="pageClass" value="<%= studentClass %>">
    <input type="hidden" id="pageSection" value="<%= section %>">
    <input type="hidden" id="pageYear" value="<%= academicYear %>">
    <input type="hidden" id="pageTerminal" value="<%= terminal %>">

    <div class="sheets-container">

    <% studentWisedata.forEach((data) => { %>

    <div class="sheet">
        <div class="watermark"><img src="/image.png" alt="Watermark"></div>

        <!-- HEADER -->
        <div class="header">
            <div class="logo"><img src="/image.png" onerror="this.style.display='none'"></div>
            <div class="head-text">
                <div class="school-name">United English Boarding School</div>
                <div class="school-meta">Manahari-8, Simpani &nbsp; | &nbsp; Phone: 057-414040</div>
            </div>
            <div class="report-title"><div>ACADEMIC PROGRESS REPORT</div>
                <div style="font-size:12px;color:var(--muted)"><%= terminal %> Terminal - <%= academicYear %></div></div>
        </div>

    <!-- Student Info -->
    <div class="student-info">
        <div><span class="info-label">Student Name:</span> <span class="info-value"><%= data.name %></span></div>
        <div><span class="info-label">Roll No:</span> <span class="info-value"><%= data.roll %></span></div>
        <div><span class="info-label">Class:</span> <span class="info-value"><%= studentClass %></span></div>
        <div><span class="info-label">Section:</span> <span class="info-value"><%= section %></span></div>
        <div><span class="info-label">Academic Year:</span> <span class="info-value"><%= academicYear || 'N/A' %></span></div>
    </div>

    <!-- SUBJECT TABLE -->
    <table>
        <thead>
            <tr>
                <th>S.N</th>
                <th>Subject</th>
                <th>Credit Hour</th>
                
                <th>Th GP</th>
                <th>Pr GP</th>
                <th>Final GP</th>
                <th>Final Grade</th>
                <th>Remarks</th>
            </tr>
        </thead>

        <tbody>

        <% 
        let totalCredit = 0;
        let m;
        let totalGradePoints = 0;

        function getGP(percent) {
            if (percent >= 90) return 4.0;
            if (percent >= 80) return 3.6;
            if (percent >= 70) return 3.2;
            if (percent >= 60) return 2.8;
            if (percent >= 50) return 2.4;
            if (percent >= 40) return 2.0;
            if (percent >= 35) return 1.6;
            return 0.0;
        }

        function getGrade(gp) {
            if (gp === 4.0) return "A+";
            if (gp >= 3.6) return "A";
            if (gp >= 3.2) return "B+";
            if (gp >= 2.8) return "B";
            if (gp >= 2.4) return "C+";
            if (gp >= 2.0) return "C";
            if (gp >= 1.6) return "D";
            return "NG";
        }
        %>

        <% data.subjects.forEach((sub, index) => { %>

        <% 
        let thP = (sub.theorymarks / sub.theoryfullmarks) * 100;

        <!-- calculating practical marks dynamically -->

          



        let prP = (sub.practicalmarks / sub.practicalfullmarks) * 100;
        let finalP = ((sub.theorymarks + sub.practicalmarks) /
                      (sub.theoryfullmarks + sub.practicalfullmarks)) * 100;

        let thGP = getGP(thP);
        let prGP = getGP(prP);
        let theoryCreditHour = creditHourData.filter(ch => ch.newsubject === sub.subject)[0]?.theoryCreditHour || 0;
        let practicalCreditHour = creditHourData.filter(ch => ch.newsubject === sub.subject)[0]?.practicalCreditHour || 0;
        let finalGP = (thGP*theoryCreditHour + prGP*practicalCreditHour) / (theoryCreditHour + practicalCreditHour);

   
       
        %>

        <tr>
          
            <td><%= index + 1 %></td>
            <td><%= sub.subject %></td>
            <td><% m =  creditHourData.filter(ch => ch.newsubject === sub.subject)[0]?.theoryCreditHour + creditHourData.filter(ch => ch.newsubject === sub.subject)[0]?.practicalCreditHour  || 'N/A' %><%= m %></td>
           
            <td><%= thGP %></td>
            <td><%= prGP %></td>
            <td><%= finalGP %></td>
                 <% totalCredit += m; 
                  totalGradePoints += (thGP*theoryCreditHour + prGP*practicalCreditHour);%>
            <td><%= getGrade(finalGP) %></td>
            <td><% function getRemarks(finalgrade)
            {
                if (finalgrade === "NG") return "Needs Improvement";
                else if(finalgrade === "D") return "Satisfactory";
                else if(finalgrade === "C" || finalgrade === "C+") return "Good";
                else if(finalgrade === "B" || finalgrade === "B+") return "Very Good";
                else return "Excellent Performance";
            }%><%= getRemarks(getGrade(finalGP)) %></td>
        </tr>
<% totalAttendance = sub.attendance %>
        <% }) %>

        </tbody>
    </table>

        <!-- SUMMARY -->
        <div class="summary">
            <div>Total Credit Hours: <%= totalCredit %></div>
               <div><span class="info-label">Attendance:</span> <span class="info-value"><%= totalAttendance || 'N/A' %></span></div>
            <div>GPA: <%= (totalGradePoints / totalCredit).toFixed(2) %></div>
        </div>

    <!-- REMARKS -->
    <div class="remark-box">
        <b>Remarks:</b><br>
        <% let gpa = (totalGradePoints / totalCredit); %>
        <% if (gpa >= 3.6) { %> Excellent Performance
        <% } else if (gpa >= 3.2) { %> Very Good
        <% } else if (gpa >= 2.4) { %> Good
        <% } else if (gpa >= 2.0) { %> Satisfactory
        <% } else { %> Needs Improvement <% } %>
    </div>

    <p><b>Issued Date:</b> <%= new Date().toLocaleDateString() %></p>

    <!-- SIGNATURES -->
    <div class="sign-row">
        <div>
            <br><br>________________________<br>
              &ensp;&ensp; &ensp;  Class Teacher
        </div>
        <div>
            <br><br>______________________<br>
                &ensp; Exam Coordinator
        </div>
        <div>
            <br><br>____________________<br>
                     &ensp;&ensp; &ensp;      Principal
        </div>
    </div>
        <hr>

        <!-- GRADING SCALE -->
        <div class="grading-scale">
                <table>
                        <tr>
                                <td>90% and above : A+</td>
                                <td>80% and above : A</td>
                                <td>70% and above : B+</td>
                                <td>60% and above : B</td>
                        </tr>
                        <tr>
                                <td>50% and above: C+</td>
                                <td>40% and above: C</td>
                                <td>35% and above: D</td>
                                <td>Below 35% : NG</td>
                        </tr>
                </table>
        </div>

</div>

<% }) %>


<!-- Include html2pdf from CDN for client-side PDF export and small helpers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
    // Download all marksheets as a single PDF
    function downloadPdf(){
        const studentClass = document.getElementById('pageClass').value;
        const section = document.getElementById('pageSection').value;
        const year = document.getElementById('pageYear').value;
        const terminal = document.getElementById('pageTerminal').value;
        const filename = `${studentClass}-${section}-${year}-${terminal}-marksheet.pdf`;
        
        const element = document.querySelector('.sheets-container');
        const opt = {
            margin:       [8, 8, 8, 8],
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.95 },
            html2canvas:  { scale: 2, useCORS: true, letterRendering: true, logging: false },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };
        // hide controls while creating pdf
        const controls = document.querySelectorAll('.no-print');
        controls.forEach(c=>c.style.display='none');
        html2pdf().set(opt).from(element).save().then(()=>{
            controls.forEach(c=>c.style.display='flex');
        }).catch((err)=>{
            console.error('PDF Error:', err);
            controls.forEach(c=>c.style.display='flex');
        });
    }

    // Export visible content to a Word (.doc) file
    function exportToWord(){
        const studentClass = document.getElementById('pageClass').value;
        const section = document.getElementById('pageSection').value;
        const year = document.getElementById('pageYear').value;
        const terminal = document.getElementById('pageTerminal').value;
        const filename = `${studentClass}-${section}-${year}-${terminal}-marksheet.doc`;
        
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>";
        const footer = "</html>";
        let content = '';
        document.querySelectorAll('.sheet').forEach(function(s){
            // clone node to avoid modifying original
            const clone = s.cloneNode(true);
            // remove watermark images for word export if desired
            clone.querySelectorAll('.watermark').forEach(w=>w.parentNode.removeChild(w));
            content += clone.innerHTML + '<div style="page-break-after:always"></div>';
        });
        const blob = new Blob([header + content + footer], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        },0);
    }
</script>

</body>
</html>
