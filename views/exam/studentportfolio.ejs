<!DOCTYPE html>
<html lang="en">
<head>
   <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portfolio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* CSS Variables & Reset */
    :root {
      --primary: #042c83;
      --secondary: #f8ab4d;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #334155;
      --border: #e2e8f0;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    * { box-sizing: border-box; }

    /* Form Styles */
    .filter-container { 
        background: var(--card-bg); 
        padding: 20px; 
        border-radius: 12px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        margin-bottom: 30px; 
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
    .header h1 { margin: 0 0 5px 0; color: var(--secondary); font-size: 1.5rem; }
    .header p { margin: 0 0 20px 0; color: #64748b; font-size: 0.9rem; }
    
    .form-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }
    .form-group { flex: 1; min-width: 200px; }
    label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color: var(--secondary); }
    select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
    button { background: var(--secondary); color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
    button:hover { opacity: 0.9; }

    /* Portfolio Card */
    .student-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 40px;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Header Profile Section (CV Style) */
    .profile-header {
        background: var(--secondary);
        color: white;
        padding: 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }

    .profile-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .profile-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #ffffff;
        border: 4px solid rgba(255,255,255,0.2);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        background-color: #fff;
        flex-shrink: 0;
    }
    
    .profile-img img { width: 100%; height: 100%; object-fit: cover; }

    .profile-info h2 { margin: 0 0 5px 0; font-size: 1.8rem; font-weight: 700; }
    .profile-info p { margin: 0; color: #cbd5e1; font-size: 0.95rem; }

    .profile-right {
        text-align: right;
    }

    .zone-badge {
        padding: 8px 20px;
        border-radius: 30px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        display: inline-block;
    }
    .zone-green { background: var(--success); color: white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
    .zone-red { background: var(--danger); color: white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
    .zone-orange { background: var(--warning); color: white; }

    /* Main Content */
    .portfolio-content {
        padding: 30px;
        background: #fff;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 20px;
        border-bottom: 2px solid var(--bg);
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Charts Section */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 40px;
    }
    
    @media (min-width: 768px) {
        .charts-grid { grid-template-columns: 1fr 1fr; }
    }

    .chart-box {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 15px;
        height: 350px;
        position: relative;
    }
    
    .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 10px;
        text-align: center;
    }

    /* Tables Grid */
    .subjects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .subject-card {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
    }
    
    .subject-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .subject-header {
        background: #f8fafc;
        padding: 10px 15px;
        font-weight: 600;
        color: var(--secondary);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid var(--border); }
    th { background: #f1f5f9; color: #64748b; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    tr:last-child td { border-bottom: none; }
    
    .mark-cell { font-weight: 500; }
    .mark-fail { color: var(--danger); font-weight: 700; }
    .mark-pass { color: var(--success); }

  </style>
</head>
<body>
  
  <div class="filter-container">
    <div class="header">
      <h1>Student Portfolio</h1>
      <p>Select criteria to view individual student performance</p>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="classSection">Class & Section</label>
        <select name="classSection" id="classSection">
          <option value="" selected disabled>Choose class & section</option>
          <% studentClassdata.forEach((data)=>{%>
            <option value="<%=data.studentClass%>-<%=data.section%>"><%=data.studentClass%>-<%=data.section%></option>
          <%})%>
        </select>
      </div>
      
      <div class="form-group">
        <label for="academicYear">Academic Year</label>
        <select name="academicYear" id="academicYear">
          <option value="" selected disabled>Choose Academic Year</option>
          <% currentYear = Number(marksheetSetups[0].academicYear) %>;
            <% for (let i = 0; i < 5; i++) { %>
              <option value="<%= currentYear - i %>"><%= currentYear - i %></option>
            <% } %>
        </select>
      </div>
    </div>
    <div style="text-align: right;">
      <button onclick="loadform()">Load Portfolio</button>
    </div>
  </div>

  <script>
    function loadform()
    {
        const classSection = document.getElementById('classSection').value
        if(!classSection) return alert("Please select Class & Section");
        
        const studentClass = classSection.split("-")[0];
        const section = classSection.split("-")[1];
        const academicYear = document.getElementById('academicYear').value;
     
        window.location.href=(`/studentportfolio?studentClass=${studentClass}&section=${section}&academicYear=${academicYear}`)
    }
  </script>

  <% if(studentWisedatastructured){ %>
    <% Object.entries(studentWisedatastructured).forEach(([reg, student]) => { %>
       <!-- Logic to determine Zone -->
       <% 
          let totalSubjects = 0;
          let failedSubjects = 0;
          let allTerminals = new Set();
          let subjectPerformance = {}; // subject -> { term: marks }
          let subjectYearlyPerformance = {}; // subject -> { year: marks }
          let allYears = new Set();

          // Process data for charts and zone
          Object.entries(student.records).forEach(([year, record]) => {
             allYears.add(year);
             Object.entries(record).forEach(([subject, termdata]) => {
                if(!subjectPerformance[subject]) subjectPerformance[subject] = {};
                if(!subjectYearlyPerformance[subject]) subjectYearlyPerformance[subject] = {};
                
                let yearTotal = 0;
                let yearCount = 0;

                Object.entries(termdata).forEach(([terminal, data]) => {
                    allTerminals.add(terminal);
                    subjectPerformance[subject][terminal] = data.theory;
                    
                    // Assuming < passMark is fail for visual indication
                    if(data.theory < data.passMarks) failedSubjects++; 
                    totalSubjects++;
                    
                    yearTotal += data.theory;
                    yearCount++;
                });
                
                if(yearCount > 0) {
                    subjectYearlyPerformance[subject][year] = (yearTotal / yearCount).toFixed(2);
                }
             });
          });

          let zoneClass = 'zone-green';
          let zoneText = 'Green Zone';
          if (failedSubjects > 0) {
             zoneClass = 'zone-red';
             zoneText = 'Red Zone';
          }
       %>

       <div class="student-card">
          <header class="profile-header">
             <div class="profile-left">
                 <div class="profile-img">
                    <!-- Placeholder for student image -->
                    <span>üßëüèª‚Äçüéì</span>
                 </div>
                 <div class="profile-info">
                     <h2 class="student-name"><%= student.name %></h2>
                     <p>Reg No: <%= reg %> | Class: <%= student.studentClass %> | Section: <%= student.section %></p>
                 </div>
             </div>
             <div class="profile-right">
                 <div class="zone-badge <%= zoneClass %>">
                    <%= zoneText %>
                 </div>
             </div>
          </header>

          <main class="portfolio-content">
             
             <div class="charts-grid">
                <div class="chart-box">
                   <div class="chart-title">Performance Across Terminals (Current Year)</div>
                   <canvas id="chart_term_<%= reg %>"></canvas>
                </div>
                <div class="chart-box">
                   <div class="chart-title">Subject Performance Across Years</div>
                   <canvas id="chart_year_<%= reg %>"></canvas>
                </div>
             </div>

             <div class="section-title">
                <span>üìä</span> Academic Progress Report
             </div>
             
             <div class="subjects-grid">
                <% Object.entries(student.records).forEach(([year, record]) => { %>
                   <% Object.entries(record).forEach(([subject, termdata]) => { %>
                      <div class="subject-card">
                         <div class="subject-header">
                            <span><%= subject %></span>
                            <span style="font-size:0.8em; opacity:0.7; background:rgba(0,0,0,0.05); padding:2px 6px; border-radius:4px;"><%= year %></span>
                         </div>
                         <table cellspacing="0">
                            <thead>
                               <tr>
                                  <% 
                                    // Sort terminals: First, Second, Third, Final (Case Insensitive)
                                    const termOrder = ['first', 'second', 'third', 'final'];
                                    const sortedTerms = Object.keys(termdata).sort((a, b) => {
                                        const lowerA = a.toLowerCase();
                                        const lowerB = b.toLowerCase();
                                        const indexA = termOrder.findIndex(t => lowerA.includes(t));
                                        const indexB = termOrder.findIndex(t => lowerB.includes(t));
                                        
                                        const valA = indexA === -1 ? 999 : indexA;
                                        const valB = indexB === -1 ? 999 : indexB;
                                        
                                        return valA - valB;
                                    });
                                  %>
                                  <% sortedTerms.forEach(term => { %>
                                     <th><%= term %></th>
                                  <% }) %>
                               </tr>
                            </thead>
                            <tbody>
                               <tr>
                                  <% sortedTerms.forEach(term => { 
                                       const data = termdata[term];
                                  %>
                                     <td class="mark-cell <%= data.theory < 35 ? 'mark-fail' : 'mark-pass' %>">
                                        <%= data.theory %>
                                     </td>
                                  <% }) %>
                               </tr>
                            </tbody>
                         </table>
                      </div>
                   <% }) %>
                <% }) %>
             </div>

             <div class="section-title" style="margin-top: 40px;">
                <span>üîÆ</span> Prediction Marks
             </div>

             <div class="prediction-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                <% Object.entries(student.records).forEach(([year, record]) => { %>
                   <% Object.entries(record).forEach(([subject, termdata]) => { 
                        // Logic to extract marks
                        const findMark = (tName) => {
                            const key = Object.keys(termdata).find(k => k.toLowerCase().includes(tName.toLowerCase()));
                            return key ? parseFloat(termdata[key].theory) : null;
                        };

                        // Get full marks from any available terminal data
                        const anyTermKey = Object.keys(termdata)[0];
                        const fullMarks = anyTermKey ? (parseFloat(termdata[anyTermKey].theoryfullmarks) || 50) : 50;

                        const first = findMark('first');
                        const second = findMark('second');
                        const third = findMark('third');
                        
                        let prediction = null;
                        let predictionLabel = '';

                        // Linear Regression Helper
                        const predictNext = (values) => {
                            const n = values.length;
                            if (n < 2) return null;
                            
                            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                            for (let i = 0; i < n; i++) {
                                const x = i + 1;
                                const y = values[i];
                                sumX += x;
                                sumY += y;
                                sumXY += x * y;
                                sumXX += x * x;
                            }
                            
                            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                            const intercept = (sumY - slope * sumX) / n;
                            
                            return slope * (n + 1) + intercept;
                        };

                        // Prediction Logic
                        if (first !== null && second !== null && third !== null) {
                            // Predict Final based on First, Second, Third
                            prediction = predictNext([first, second, third]);
                            predictionLabel = 'Final Term';
                        } else if (first !== null && second !== null) {
                            // Predict Third based on First, Second
                            prediction = predictNext([first, second]);
                            predictionLabel = 'Third Term';
                        }

                        if (prediction !== null) {
                            // Cap prediction at fullMarks and floor at 0
                            prediction = Math.min(fullMarks, Math.max(0, prediction));
                   %>
                      <div class="prediction-card" style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--secondary);">
                         <div style="font-weight: 600; color: var(--text);">
                            <%= subject %>
                            <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 400;"><%= year %></div>
                         </div>
                         <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><%= Math.round(prediction) %></div>
                            <div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;"><%= predictionLabel %></div>
                         </div>
                      </div>
                   <% } %>
                   <% }) %>
                <% }) %>
             </div>

          </main>
       </div>

       <!-- Scripts for Charts -->
       <script>
          {
             // Sort terminals for chart
             const termOrder = ['first', 'second', 'third', 'final'];
             const terminals = <%- JSON.stringify(Array.from(allTerminals)) %>.sort((a, b) => {
                const lowerA = a.toLowerCase();
                const lowerB = b.toLowerCase();
                const indexA = termOrder.findIndex(t => lowerA.includes(t));
                const indexB = termOrder.findIndex(t => lowerB.includes(t));
                
                const valA = indexA === -1 ? 999 : indexA;
                const valB = indexB === -1 ? 999 : indexB;
                
                return valA - valB;
             });
             
             const subjectData = <%- JSON.stringify(subjectPerformance) %>;
             
             // Prepare datasets for Terminal Chart
             const datasets = Object.entries(subjectData).map(([subject, terms], index) => {
                const data = terminals.map(t => terms[t] || 0);
                const colors = ['#2563eb', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                return {
                   label: subject,
                   data: data,
                   borderColor: colors[index % colors.length],
                   backgroundColor: colors[index % colors.length],
                   tension: 0.3,
                   fill: false,
                   pointRadius: 4
                };
             });

             const ctxTerm = document.getElementById('chart_term_<%= reg %>').getContext('2d');
             new Chart(ctxTerm, {
                type: 'line',
                data: {
                   labels: terminals,
                   datasets: datasets
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                      legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                   },
                   scales: { y: { beginAtZero: true } }
                }
             });

             // Year Chart - Subject wise
             const years = <%- JSON.stringify(Array.from(allYears).sort()) %>;
             const subjectYearlyData = <%- JSON.stringify(subjectYearlyPerformance) %>;
             
             const yearDatasets = Object.entries(subjectYearlyData).map(([subject, yearData], index) => {
                const data = years.map(y => yearData[y] || 0);
                const colors = ['#2563eb', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                return {
                   label: subject,
                   data: data,
                   borderColor: colors[index % colors.length],
                   backgroundColor: colors[index % colors.length],
                   tension: 0.3,
                   fill: false,
                   pointRadius: 4
                };
             });
             
             const ctxYear = document.getElementById('chart_year_<%= reg %>').getContext('2d');
             new Chart(ctxYear, {
                type: 'line',
                data: {
                   labels: years,
                   datasets: yearDatasets
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                      legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                   },
                   scales: { y: { beginAtZero: true } }
                }
             });
          }
       </script>

    <% }) %>
  <% } %>

</body>
</html>