<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comprehensive Analytics Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #1e293b;
      --accent: #f59e0b;
      --bg-gray: #f8fafc;
      --border: #e2e8f0;
      --text: #334155;
      --success: #10b981;
      --danger: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #e5e7eb;
      color: var(--text);
      line-height: 1.5;
      padding: 20px 0;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    /* Action Buttons & Form */
    .action-buttons {
      max-width: 297mm;
      margin: 0 auto 20px;
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .selector-title {
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: 0.5rem;
    }

    .selector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }

    select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .load-btn { background: var(--secondary); color: white; }
    .btn-print { background: var(--primary); color: white; align-self: flex-start; }
    
    /* Report Page */
    .page {
      width: 297mm; /* Landscape A4 */
      min-height: 210mm;
      margin: 0 auto 20mm;
      background: #fff;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      padding: 15mm;
      position: relative;
      page-break-after: always;
    }
    
    .page:last-child { page-break-after: auto; }
    
    .report-header {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 1rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    
    .report-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--secondary);
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }
    
    .report-subtitle {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }

    .section-header {
        margin: 2rem 0 1rem;
        color: var(--secondary);
        font-size: 18px;
        font-weight: 700;
        border-left: 4px solid var(--accent);
        padding-left: 10px;
    }
    
    /* Insight Box */
    .insight-box {
        background-color: #f8fafc;
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
    }

    .insight-box h4 {
        color: var(--secondary);
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .insight-text {
        font-size: 0.9rem;
        color: #475569;
        line-height: 1.6;
    }

    /* Tables */
    .table-container {
        margin-bottom: 2rem;
        overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      border: 1px solid var(--border);
    }
    
    thead th {
      background-color: #f1f5f9;
      color: var(--secondary);
      font-weight: 700;
      padding: 10px 8px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      letter-spacing: 0.5px;
    }

    tbody td {
      padding: 8px;
      border: 1px solid var(--border);
      text-align: center;
      color: var(--text);
      vertical-align: middle;
    }
    
    tbody tr:nth-child(even) { background: #fcfcfc; }
    tbody tr:hover { background: #f1f5f9; }
    
    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        page-break-inside: avoid;
    }

    .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--secondary);
    }

    .stat-detail {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 2px;
    }

    .fail-list {
        margin-top: 1rem;
        font-size: 12px;
        color: var(--danger);
        background: #fef2f2;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #fee2e2;
    }

    @media print {
      body { background: none; padding: 0; }
      .action-buttons, .no-print { display: none !important; }
      .page { 
          margin: 0; 
          box-shadow: none; 
          width: 100%; 
          padding: 10mm;
          page-break-after: always;
      }
      .page:last-child { page-break-after: auto; }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
    }
    
    @page { size: A4 landscape; margin: 0; }
  </style>
</head>
<body>
  <div class="action-buttons no-print">
    <div class="selector-title">Report Configuration</div>
    <div class="selector-grid">
       <div class="form-group">
          <select name="subject" id="subject">
            <option value="">Choose subject</option>
            <% uniqueSubjects = new Set(subjects.map((subject)=>subject.newsubject)) %>
            <%uniqueSubjects.forEach((subject)=>{%>
              <option value="<%=subject%>"><%=subject%></option>
            <%})%>
          </select>
        </div>
      <select name="classSection" id="classSection">
        <option value="" disabled>Choose Class</option>
        <% studentClassdata.forEach((data)=>{%>
          <option value="<%=data.studentClass%>"><%=data.studentClass%></option>
        <%})%>
      </select>
      <select name="section" id="section">
        <option value="" disabled>Choose Section</option>
        <% studentClassdata.forEach((data)=>{ %>
            <option value="<%=data.section%>"><%=data.section%></option>
          <% }) %>
      </select>
      <select name="terminals" id="terminal">
        <option value="" selected disabled>Choose Terminal</option>
        <%marksheetSetups[0].terminals.forEach((terminal)=>{%>
          <option value="<%=terminal.name%>"><%=terminal.name%></option>
        <% }) %>
      </select>
      <select name="academicYear" id="academicYear">
            <option value="" selected disabled>Choose Academic Year</option>
            <% currentYear = Number(marksheetSetups[0].academicYear) %>;
              <% for (let i = 0; i < 5; i++) { %>
                <option value="<%= currentYear - i %>"><%= currentYear - i %></option>
              <% } %>
      </select>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="load-btn" onclick="loadform()">Generate Report</button>
        <button class="btn-print" onclick="window.print()">Print Report</button>
    </div>
  </div>

  <script>
    function loadform()
    {
        const selectedSubject = document.getElementById('subject').value;
        const classSection = document.getElementById('classSection').value
        const studentClass = document.getElementById('classSection').value;
        const section = document.getElementById('section').value;
        const academicYear = document.getElementById('academicYear').value;
        const terminal = document.getElementById('terminal').value

        window.location.href=(`/analytics?studentClass=${studentClass}&section=${section}&subject=${selectedSubject}&terminal=${terminal}&academicYear=${academicYear}`)
      
    }
  </script>
  
  <div class="page">
    <div class="report-header">
      <div>
          <h1 class="report-title">Comprehensive Analytics Report</h1>
          <p class="report-subtitle">Academic Year: <%= academicYear %></p>
      </div>
      <div class="report-meta">Generated on: <%= new Date().toLocaleDateString() %></div>
    </div>
    
    <div class="section-header">Class Wise Analysis Per Subject</div>
    
<% const groupedByterminal = Object.groupBy(classSubjectAnalysis,item=>item._id.terminal); %>


<% for (const terminal in groupedByterminal) { %>

  <h3>Terminal: <%= terminal %></h3>

  <% const data = groupedByterminal[terminal]; %>

  <!-- Extract subjects dynamically -->
  <% const subjectsArr = [...new Set(data.map(i => i._id.subject))]; %>

  <!-- Group by class -->
  <% const byClass = Object.groupBy(data, i => i._id.studentClass); %>

  <div class="table-container">
  <table border="1" cellspacing="0" cellpadding="5">
    <thead>
        <tr>
        <th>Class</th>
        <% subjectsArr.forEach(sub => { %>
            <th colspan="4"><%= sub %></th>
        <% }) %>
        </tr>

        <tr>
        <th></th>
        <% subjectsArr.forEach(sub => { %>
            <th>Total</th>
            <th>Pass</th>
            <th>Fail</th>
            <th>Avg</th>
        <% }) %>
        </tr>
    </thead>
    <tbody>
    <% for (const classNo in byClass) { %>
      <tr>
        <td style="font-weight:bold;"><%= classNo %></td>

        <% 
          // Group subjects inside this class
          const subGroup = Object.groupBy(byClass[classNo], i => i._id.subject);
        %>


        <% subjectsArr.forEach(sub => { 
             const row = subGroup[sub]?.[0]; 
        %>

            <% if (row) { %>
                <td><%= row.totalStudents %></td>
                <td style="color:var(--success)"><%= row.pass %></td>
                <td style="color:var(--danger)"><%= row.fail %></td>
                <td><%= row.avgMarks.toFixed(2)  %></td>
            <% } else { %>
                <td>-</td><td>-</td><td>-</td><td>-</td>
            <% } %>

        <% }) %>

      </tr>
    <% } %>
    </tbody>
  </table>
  </div>

<% } %>

  </div>


  <div class="page">
  <div class="report-header">
    <div>
        <h1 class="report-title">Section Wise Analysis</h1>
        <p class="report-subtitle">Detailed Subject Performance</p>
    </div>
  </div>
    
    <div class="insight-box">
        <h4><span style="font-size:1.2em">üí°</span> Key Insights</h4>
        <div class="insight-text">
            ‡•ß) ‡§§‡§≤ ‡§¶‡§ø‡§è‡§ï‡•ã data ‡§≤‡•á ‡§ï‡•Å‡§®‡•à ‡§™‡§®‡§ø section ‡§Æ‡§æ ‡§ï‡•Å‡§® ‡§µ‡§ø‡§∑‡§Ø‡§ï‡•ã ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§ï‡§∏‡•ç‡§§‡•ã ‡§õ ‡§≠‡§®‡•ç‡§®‡•á ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ‡•§ <br>
            ‡•®) ‡§è‡§â‡§ü‡§æ Section ‡§Æ‡§æ ‡§∏‡§¨‡•à ‡§≠‡§®‡•ç‡§¶‡§æ ‡§ß‡•á‡§∞‡•à ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ï‡•Å‡§® ‡§µ‡§ø‡§∑‡§Ø‡§Æ‡§æ ‡§´‡•á‡§≤ ‡§≠‡§è ‡§∞ ‡§ï‡§§‡§ø ‡§ú‡§®‡§æ ‡§´‡•á‡§≤ ‡§≠‡§è ‡§≠‡§®‡•ç‡§®‡•á ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ‡•§
        </div>
    </div>
    
    <% Object.entries(finalStructureSectionAnalysis).forEach(([academicYear, yearData]) =>{
      Object.entries(yearData).forEach(([terminal, terminalData])=>{
    %>

        <% Object.entries(terminalData).forEach(([classSection, records])=>{%>
          <div class="section-header">
             Academic Year: <%= academicYear %> | Terminal: <%= terminal %> | Class-Section: <%= classSection %>
          </div>
          
          <div class="table-container">
          <table cellspacing="0" border="1">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Total Students</th>
                <th>Pass</th>
                <th>Fail</th>
                <th>Pass %</th>
                <th>Fail %</th>
                <th>Average Marks</th>
                <th>Highest Marks</th>
                <th>Lowest Marks</th>
                <th>Median Marks</th>
              </tr>
            </thead>
            <tbody>
              <% records.forEach((record) => { %>
                <tr>
                  <td style="font-weight:600; text-align:left;"><%= record._id.subject %></td>
                  <td><%= record.totalStudents %></td>
                  <td style="color:var(--success)"><%= record.pass %></td>
                  <td style="color:var(--danger)"><%= record.fail %></td>
                  <td><%= ((record.pass / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= ((record.fail / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= record.avgMarks.toFixed(2) %></td>
                  <td><%= record.highestMarks %></td>
                  <td><%= record.lowestMarks %></td>
                  <td><%= record.medianMarks %></td>
                </tr>
               
              <% }) %>
            </tbody>
          </table>
          </div>

          <% 
             const maxFailRec = records.reduce((max, rec) => rec.fail > max.fail ? rec : max, records[0]);
             const maxPassRec = records.reduce((acc,rec)=> acc.pass>rec.pass?acc:rec,records[0]);
             const highestAvgRec = records.reduce((max, rec) => rec.avgMarks > max.avgMarks ? rec : max, records[0]);
          %>

          <div class="summary-grid">
              <div class="stat-card" style="border-left: 4px solid var(--danger);">
                  <div class="stat-label">Max Fail Subject</div>
                  <div class="stat-value"><%= maxFailRec._id.subject %></div>
                  <div class="stat-detail">Fail Count: <%= maxFailRec.fail %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--success);">
                  <div class="stat-label">Max Pass Subject</div>
                  <div class="stat-value"><%= maxPassRec._id.subject %></div>
                  <div class="stat-detail">Pass Count: <%= maxPassRec.pass %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--primary);">
                  <div class="stat-label">Highest Average</div>
                  <div class="stat-value"><%= highestAvgRec._id.subject %></div>
                  <div class="stat-detail">Avg Marks: <%= highestAvgRec.avgMarks.toFixed(2) %></div>
              </div>
          </div>

          <% const key = `${classSection}`; %>
          <% const failData = failpersectionlookup[key]; %>
          
          <% if(failData && failData.length > 0) { %>
          <div class="fail-list">
             <strong>Fail Count Distribution:</strong>
             <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:5px;">
                 <% failData.forEach((data)=>{ %>
                  <span>‚Ä¢ <%=data._id.failCount %>-subject Fail: <strong><%= data.totalFailCount %></strong> Student(s)</span>
                 <%})%>
             </div>
          </div>
          <% } %>
          
          <hr style="margin: 2rem 0; border:0; border-top:1px dashed #ccc;">
        <%})%>
    <%})%>
    <%})%>
  <div class="page">
  <div class="report-header">
    <div>
        <h1 class="report-title">Subject Specific Analysis</h1>
        <p class="report-subtitle">Performance Across Classes</p>
    </div>
  </div>
  
    <div class="insight-box">
        <h4><span style="font-size:1.2em">üí°</span> Key Insights</h4>
        <div class="insight-text">
            1) ‡§§‡§≤ ‡§¶‡§ø‡§è‡§ï‡•ã data ‡§≤‡•á ‡§ï‡•Å‡§® ‡§µ‡§ø‡§∑‡§Ø ‡§ï‡•Å‡§® ‡§ï‡§ï‡•ç‡§∑‡§æ‡§Æ‡§æ ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§™‡•ç‡§∞‡§¶‡§∂‡§® ‡§ó‡§∞‡§ø‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡§∞ ‡§ï‡•Å‡§® ‡§ï‡§ï‡•ç‡§∑‡§æ ‡§Æ‡§æ ‡§ñ‡§∞‡§æ‡§¨ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ó‡§∞‡§ø‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡§≠‡§®‡•ç‡§®‡•á ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ‡•§<br>
            ‡•®) ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä‡§π‡§∞‡•Å‡§ï‡•ã marks ‡§ï‡•Å‡§® range ‡§Æ‡§æ ‡§¨‡§¢‡•Ä ‡§™‡§∞‡•á‡§ï‡•ã ‡§õ ‡§≠‡§®‡•ç‡§®‡•á ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ‡•§ 
        </div>
    </div>

    <% Object.entries(subjectAnalysisFinalStructure).forEach(([academicYear, yearData]) =>{
      Object.entries(yearData).forEach(([terminal, terminalData])=>{
    %>

        <% Object.entries(terminalData).forEach(([subject, records])=>{%>
          <div class="section-header">
             Academic Year: <%= academicYear %> | Terminal: <%= terminal %> | Subject: <%= subject %>
          </div>
          
          <div class="table-container">
          <table cellspacing="0" border="1">
            <thead>
              <tr>
                <th>Class-Section</th>
                <th>Total</th>
                <th>Pass</th>
                <th>Fail</th>
                <th>Pass %</th>
                <th>Fail %</th>
                <th>Avg Marks</th>
                <th>Highest</th>
                <th>Lowest</th>
                <th>Median</th>
                <th style="width:25%">Mark Range Distribution</th>
              </tr>
            </thead>
            <tbody>
              <% records.forEach((record) => { %>
                <tr>
                  <td style="font-weight:600"><%= record._id.studentClass %>-<%= record._id.section %></td>
                  <td><%= record.totalStudents %></td>
                  <td style="color:var(--success)"><%= record.pass %></td>
                  <td style="color:var(--danger)"><%= record.fail %></td>
                  <td><%= ((record.pass / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= ((record.fail / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= record.avgTheory.toFixed(2) %></td>
                  <td><%= record.highestMarkstheory %></td>
                  <td><%= record.lowestMarkstheory %></td>
                  <td><%= record.medianMarkstheory %></td>
                  <td style="text-align:left; font-size:10px; line-height:1.4;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2px;">
                       <span>0-20%: <b><%=record.range1theory %></b></span>
                       <span>21-40%: <b><%=record.range2theory %></b></span>
                       <span>41-60%: <b><%= record.range3theory %></b></span>
                       <span>61-80%: <b><%=record.range4theory %></b></span>
                       <span>81-100%: <b><%=record.range5theory %></b></span>
                    </div>
                   </td>
                </tr>
               
              <% }) %>
            </tbody>
          </table>
          </div>

          <% 
             const maxFailRec = records.reduce((max, rec) => rec.fail > max.fail ? rec : max, records[0]);
             const maxPassRec = records.reduce((acc,rec)=> acc.pass>rec.pass?acc:rec,records[0]);
             const highestAvgRec = records.reduce((max, rec) => rec.avgTheory > max.avgTheory ? rec : max, records[0]);
          %>

          <div class="summary-grid">
              <div class="stat-card" style="border-left: 4px solid var(--danger);">
                  <div class="stat-label">Max Fail Class</div>
                  <div class="stat-value"><%= maxFailRec._id.studentClass %>-<%= maxFailRec._id.section %></div>
                  <div class="stat-detail">Fail Count: <%= maxFailRec.fail %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--success);">
                  <div class="stat-label">Max Pass Class</div>
                  <div class="stat-value"><%= maxPassRec._id.studentClass %>-<%= maxPassRec._id.section %></div>
                  <div class="stat-detail">Pass Count: <%= maxPassRec.pass %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--primary);">
                  <div class="stat-label">Highest Average Class</div>
                  <div class="stat-value"><%= highestAvgRec._id.studentClass %>-<%= highestAvgRec._id.section %></div>
                  <div class="stat-detail">Avg Marks: <%= highestAvgRec.avgTheory.toFixed(2) %></div>
              </div>
          </div>
          
          <hr style="margin: 2rem 0; border:0; border-top:1px dashed #ccc;">

          <%})%>
        <%})%>
    <%})%>
  </div>

  <div class="page">
  <div class="report-header">
    <div>
        <h1 class="report-title">Overall School Analysis</h1>
        <p class="report-subtitle">Aggregated Performance Metrics</p>
    </div>
  </div>
    
    <% Object.entries(subjectAnalysisFinalStructure).forEach(([academicYear, yearData]) =>{
      Object.entries(yearData).forEach(([terminal, terminalData])=>{
    %>

        <% Object.entries(terminalData).forEach(([subject, records])=>{%>
          <div class="section-header">
             Academic Year: <%= academicYear %> | Terminal: <%= terminal %> | Subject: <%= subject %>
          </div>
          
          <div class="table-container">
          <table cellspacing="0" border="1">
            <thead>
              <tr>
                <th>Class-Section</th>
                <th>Total</th>
                <th>Pass</th>
                <th>Fail</th>
                <th>Pass %</th>
                <th>Fail %</th>
                <th>Avg Marks</th>
                <th>Highest</th>
                <th>Lowest</th>
                <th>Median</th>
                <th style="width:25%">Mark Range Distribution</th>
              </tr>
            </thead>
            <tbody>
              <% records.forEach((record) => { %>
                <tr>
                  <td style="font-weight:600"><%= record._id.studentClass %>-<%= record._id.section %></td>
                  <td><%= record.totalStudents %></td>
                  <td style="color:var(--success)"><%= record.pass %></td>
                  <td style="color:var(--danger)"><%= record.fail %></td>
                  <td><%= ((record.pass / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= ((record.fail / record.totalStudents) * 100).toFixed(2) %></td>
                  <td><%= record.avgTheory.toFixed(2) %></td>
                  <td><%= record.highestMarkstheory %></td>
                  <td><%= record.lowestMarkstheory %></td>
                  <td><%= record.medianMarkstheory %></td>
                  <td style="text-align:left; font-size:10px; line-height:1.4;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2px;">
                       <span>0-20%: <b><%=record.range1theory %></b></span>
                       <span>21-40%: <b><%=record.range2theory %></b></span>
                       <span>41-60%: <b><%= record.range3theory %></b></span>
                       <span>61-80%: <b><%=record.range4theory %></b></span>
                       <span>81-100%: <b><%=record.range5theory %></b></span>
                    </div>
                   </td>
                </tr>
               
              <% }) %>
            </tbody>
          </table>
          </div>

          <% 
             const maxFailRec = records.reduce((max, rec) => rec.fail > max.fail ? rec : max, records[0]);
             const maxPassRec = records.reduce((acc,rec)=> acc.pass>rec.pass?acc:rec,records[0]);
             const highestAvgRec = records.reduce((max, rec) => rec.avgTheory > max.avgTheory ? rec : max, records[0]);
          %>

          <div class="summary-grid">
              <div class="stat-card" style="border-left: 4px solid var(--danger);">
                  <div class="stat-label">Max Fail Class</div>
                  <div class="stat-value"><%= maxFailRec._id.studentClass %>-<%= maxFailRec._id.section %></div>
                  <div class="stat-detail">Fail Count: <%= maxFailRec.fail %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--success);">
                  <div class="stat-label">Max Pass Class</div>
                  <div class="stat-value"><%= maxPassRec._id.studentClass %>-<%= maxPassRec._id.section %></div>
                  <div class="stat-detail">Pass Count: <%= maxPassRec.pass %></div>
              </div>
              
              <div class="stat-card" style="border-left: 4px solid var(--primary);">
                  <div class="stat-label">Highest Average Class</div>
                  <div class="stat-value"><%= highestAvgRec._id.studentClass %>-<%= highestAvgRec._id.section %></div>
                  <div class="stat-detail">Avg Marks: <%= highestAvgRec.avgTheory.toFixed(2) %></div>
              </div>
          </div>
          
          <hr style="margin: 2rem 0; border:0; border-top:1px dashed #ccc;">

          <%})%>
        <%})%>
    <%})%>
  </div>
</body>
</html>
