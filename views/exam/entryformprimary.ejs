<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marks Entry Form</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary:#ff8c42;--primary-dark:#e67a2e;--secondary:#1a3a52;--secondary-light:#2c5f8d;--bg:#f8f9fa;--card:#fff;--border:#e1e8ed;--text:#2d3748;--success:#48bb78;--hover:#fff5eb}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,var(--secondary) 0%,var(--secondary-light) 100%);min-height:100vh;padding:15px;color:var(--text)}
    
    .selector-panel{background:var(--card);border-radius:10px;padding:20px;margin:0 auto 20px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:1400px}
    .selector-title{font-size:18px;font-weight:700;color:var(--secondary);margin-bottom:15px;text-align:center;text-transform:uppercase;letter-spacing:.5px}
    .selector-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px}
    .selector-panel select{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:6px;font-size:14px;color:var(--text);background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231a3a52' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center/16px;padding-right:35px;transition:border .2s;cursor:pointer;appearance:none}
    .selector-panel select:hover{border-color:var(--primary)}
    .selector-panel select:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px rgba(255,140,66,.1)}
    .load-btn{display:block;width:100%;max-width:280px;margin:0 auto;padding:12px 28px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;border:0;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 3px 12px rgba(255,140,66,.3);text-transform:uppercase;letter-spacing:.5px}
    .load-btn:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(255,140,66,.4)}
    .load-btn:active{transform:translateY(0)}
    
    .entry-container{background:var(--card);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:1400px;margin:0 auto;overflow-x:auto}
    .entry-title{font-size:20px;font-weight:700;color:var(--secondary);margin-bottom:15px;text-align:center;text-transform:uppercase;letter-spacing:.5px;padding-bottom:12px;border-bottom:3px solid var(--primary)}
    
    table{width:100%;border-collapse:collapse;margin-top:12px;min-width:900px}
    table th{background:linear-gradient(135deg,var(--secondary) 0%,var(--secondary-light) 100%);color:#fff;padding:12px 8px;text-align:center;font-weight:600;font-size:13px;border:1px solid var(--secondary-light);position:sticky;top:0;z-index:10}
    table td{padding:8px;border:1px solid var(--border);text-align:center;background:#fff}
    table tr:nth-child(even) td{background:#fafbfc}
    table tr:hover td{background:var(--hover)}
    table input[type="text"],table input[type="number"]{width:100%;padding:7px 8px;border:1px solid var(--border);border-radius:4px;font-size:13px;transition:border .2s;text-align:center}
    table input[type="text"]:read-only{background:#f7fafc;border-color:#e2e8f0;color:#4a5568}
    table input[type="number"]:not([readonly]):focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 2px rgba(255,140,66,.1)}
    table input[readonly]{background:#edf2f7;cursor:not-allowed}
    table img{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
    
    .submit-container{text-align:center;margin-top:20px;padding-top:15px;border-top:2px solid var(--border)}
    input[type="submit"]{padding:12px 40px;background:linear-gradient(135deg,var(--success) 0%,#38a169 100%);color:#fff;border:0;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 3px 12px rgba(72,187,120,.3);text-transform:uppercase;letter-spacing:.5px}
    input[type="submit"]:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(72,187,120,.4)}
    input[type="submit"]:active{transform:translateY(0)}
    
    @media(max-width:1024px){.entry-container{padding:15px}table{font-size:12px}table th,table td{padding:7px 5px}}
    @media(max-width:768px){body{padding:10px}.selector-panel,.entry-container{padding:15px;border-radius:8px}.selector-title,.entry-title{font-size:16px}.selector-grid{grid-template-columns:1fr}.entry-container{overflow-x:scroll;-webkit-overflow-scrolling:touch}table{min-width:800px}table th,table td{font-size:11px;padding:6px 4px}table input{font-size:12px;padding:6px}input[type="submit"],.load-btn{width:100%;max-width:100%;padding:11px 20px}.entry-container::after{content:'← Scroll to view all →';display:block;text-align:center;color:var(--primary);font-size:11px;margin-top:8px;font-weight:600}}
    @media(max-width:480px){.selector-title,.entry-title{font-size:15px}table{min-width:700px}table th,table td{font-size:10px;padding:5px 3px}table img{width:32px;height:32px}}
  </style>
</head>
<body>

<div class="selector-panel">
  <div class="selector-title">Choose Class, Section and Terminal for Marks Entry</div>
  <div class="selector-grid">
     <div class="form-group">
       
        <select name="subject" id="subject">
          <option value="">Choose subject</option>
          <% uniqueSubjects = new Set(subjects.map((subject)=>subject.newsubject)) %>
          <%uniqueSubjects.forEach((subject)=>{%>
            <option value="<%=subject%>"><%=subject%></option>
          <%})%>
        </select>
      </div>
    <select name="classSection" id="classSection">
      
      <option value="" disabled>Choose Class & Section</option>
      <% studentClassdata.forEach((data)=>{%>
        <option value="<%=data.studentClass%>-<%=data.section%>"><%=data.studentClass%>-<%=data.section%></option>
      <%})%>
    </select>
    <select name="terminals" id="terminal">
      <option value="" selected disabled>Choose Terminal</option>
      <%marksheetSetups[0].terminals.forEach((terminal)=>{%>
        <option value="<%=terminal.name%>"><%=terminal.name%></option>
      <% }) %>
    </select>
<select name="academicYear" id="academicYear">
          <option value="" selected disabled>Choose Academic Year</option>
          <% currentYear = Number(marksheetSetups[0].academicYear) %>;
            <% for (let i = 0; i < 5; i++) { %>
              <option value="<%= currentYear - i %>"><%= currentYear - i %></option>
            <% } %>
        </select>
  </div>
  <button class="load-btn" onclick="loadform()">Load Form</button>
</div>


<script>
  document.getElementById('classSection').value = "<%= studentClass %>-<%= section %>";
  document.getElementById('terminal').value = "<%= terminal %>";
  document.getElementById('academicYear').value = "<%= academicYear %>";
  document.getElementById('subject').value = "<%= subject %>";
</script>

  <script>
    function loadform()
    {
        const selectedSubject = document.getElementById('subject').value;
        const classSection = document.getElementById('classSection').value
        const studentClass = classSection.split("-")[0];
        const section = classSection.split("-")[1];
        const academicYear = document.getElementById('academicYear').value;
        const terminal = document.getElementById('terminal').value

        window.location.href=(`/entryform?studentClass=${studentClass}&section=${section}&subject=${selectedSubject}&terminal=${terminal}&academicYear=${academicYear}`)
      
    }
  </script>
  <!-- end here -->

<div class="entry-container">
  <div class="entry-title">Enter Marks Data</div>
  <center><div style="font-weight: 800;">Class <%= studentClass %> - <%= section %> | <%= subject %> | <%= terminal %> Terminal- <%= academicYear %></div></center>
  <center><input type="number" placeholder="Enter total Worksheet" name="totalWorksheet" id="totalWorksheet"></center>
  

  <form action="/entryform?<%= `studentClass=${studentClass}&section=${section}&subject=${subject}&academicYear=${academicYear}&terminal=${terminal}` %>" method="POST">
   <% if (!subjectData || subjectData.length === 0) { %>
      <div style="color:red;font-weight:600;margin-top:10px;text-align:center;">Theory Marks and Practical Marks are not setup. Please contact the admin to add subject details.</div>
      <script>
        document.querySelector('#markstable').style.display = 'none';
      </script>
    <% } %>
    <table id="markstable">
      <tr id="headerRow">

        <th >Roll</th>
        <th>Name</th>
        <th>Photo</th>
        <th>
  Th Marks (
  <% if (subjectData && subjectData.length > 0) { %>
      <%= subjectData[0].theory %>
  <% } else { %>
      <span style="color:red;">Theory marks not added. Contact admin.</span>
  <% } %>
  )
</th>

  

        <th>Attendance</th>
      
   
      </tr>
      <% studentData.forEach((student,idx)=>{%>
      
        <tr id="dataEntryRow">
          <input type="hidden" name="gender[<%=student.reg%>]" value="<%=student.gender%>" readonly  >
        <input type="hidden" name="reg[<%=student.reg%>]" value="<%=student.reg%>" readonly >
          <td><input type="text" name="roll[<%=student.reg%>]" value="<%=student.roll%>" readonly ></td>
         <td><input type="text" name="name[<%=student.reg%>]" value="<%=student.name%>" readonly ></td>
          <td><img src="/student.png" alt="photo"></td>
          <td><input type="number" id="theorymarks" name="theorymarks[<%=student.reg%>]" value="" data-reg="<%= student.reg %>" min="0" data-max="<%=subjectData[0].theory%>" oninput="checkMax(this)"></td>
        
          <td><input type="number" id="attendance" name="attendance[<%=student.reg%>]" value="" data-reg="<%= student.reg %>" oninput="autoSave(this)"></td>
          
          
           
         

        </tr>

      <%})%>
    </table>

   

    <input type="hidden" id="terminal" name="terminal" value="<%=terminal%>">
    <% if (subjectData && subjectData.length > 0) { %>
     <input type="hidden" name="theoryfullmarks" id="fullMarks" value="<%=subjectData[0].theory%>">
    
     <input type="hidden" name="passMarks" id="passMarks" value="<%=subjectData[0].passingMarks%>">
   
     <input type="hidden" name="practicalfullmarks" id="practicalfullmarks" value="<%=subjectData[0].practical%>">
      <% } else { %>
       <span style="color:red;">Theory marks or practical marks are not added. Contact admin.</span>
    <%}%>
     <input type="hidden" name="studentClass" id="studentClass" value="<%=studentClass %>">
     <input type="hidden" name="section" id="section" value="<%=section %>">

  </form>
</div>
<% if (terminal == "FIRST")
{
  workingDays = marksheetSetups[0].terminals[0].workingDays;
}
else if (terminal == "SECOND")
{
  workingDays = marksheetSetups[0].terminals[1].workingDays;
}
else if (terminal == "THIRD")
{
  workingDays = marksheetSetups[0].terminals[2].workingDays;
}
else if (terminal == "FINAL")
{
  workingDays = marksheetSetups[0].terminals[3].workingDays;
}%>
<input type="hidden" id="workingDays" value="<%=workingDays%>">
  

<script>
async function populateData(subject,studentClass,section,academicYear,terminal)
{
  const data = await fetch(`/getPreviousmarks?subject=${subject}&studentClass=${studentClass}&section=${section}&academicYear=${academicYear}&terminal=${terminal}`);
  const result = await data.json();
  console.log("Fetched Previous Marks:", result);

  document.getElementById('totalWorksheet').value = result.length > 0 ? result[0].totalWorksheet : 0;
 

  const attendanceData = await fetch(`/getAttendanceData?subject=${subject}&studentClass=${studentClass}&section=${section}&academicYear=${academicYear}&terminal=${terminal}`);
  const attendanceResult = await attendanceData.json();
if(result.length>0)
{
  result.forEach((item)=>
  {
    const reg = item.reg;
    document.querySelector(`input[name="theorymarks[${reg}]"]`).value=item.theorymarks;
  
    document.querySelector(`input[name="attendance[${reg}]"]`).value=item.attendance;
    
    // Trigger input events to recalculate marks
    const theoryInput = document.querySelector(`input[name="theorymarks[${reg}]"]`);
    const attendanceInput = document.querySelector(`input[name="attendance[${reg}]"]`);
    
    if(theoryInput) theoryInput.dispatchEvent(new Event('input'));
    if(attendanceInput) attendanceInput.dispatchEvent(new Event('input'));
    
     document.querySelector(`#totalWorksheet`).dispatchEvent(new Event('input'));
setTimeout(() => {
   document.querySelectorAll(`select[name="worksheetGrades[${reg}][]"]`).forEach((select, index) => {
        if(item.worksheetGrades && item.worksheetGrades[index]) {
            select.value = item.worksheetGrades[index];
        }
      });
}, 500);
    
  });
}
else
{
  console.log("No previous data found");
}
if(attendanceResult.length>0)
{
  attendanceResult.forEach((item)=>
  {
    const reg = item.reg;
    document.querySelector(`input[name="attendance[${reg}]"]`).value=item.attendance;
    
    // Trigger input events to recalculate marks
    document.querySelector(`input[name="attendance[${reg}]"]`).dispatchEvent(new Event('input'));
  });
}
else
{
  console.log("No attendance data found");
}
}






 window.onload = function() {
const urlParams = new URLSearchParams(window.location.search);

// Fetch each parameter
const studentClass = urlParams.get('studentClass');   // "7"
const section = urlParams.get('section');             // "x"
const subject = urlParams.get('subject');             // "COMPUTER"
const terminal = urlParams.get('terminal');           // "THIRD-2082"
const academicYear = urlParams.get('academicYear');   // "" (empty string in your example)
    populateData(subject,studentClass,section,academicYear,terminal) // pass the subject here
  }


  </script>



<!-- script for autosave the data -->
 <script>
  const saveTimers = new Map();

  async function autoSave(el) {
    el.style.backgroundColor = ''
    el.style.borderColor = ''
    const reg = el.dataset.reg;
    const maxMarks = el.dataset.max;
    
    // Validate max marks
    if (maxMarks && Number(el.value) > Number(maxMarks)) {
      el.style.backgroundColor = '#fee2e2'; // Light red
      el.style.borderColor = '#f87171'; // Red border
      el.style.transition = 'background-color 0.3s ease';
      return; // Exit if max marks exceeded
    }

    // Clear existing timer for this element
    if (saveTimers.has(el)) {
        clearTimeout(saveTimers.get(el));
    }
     
    const timer = setTimeout(async()=>{
      const reg = el.dataset.reg;
      const theorymarks = document.querySelector(`input[name="theorymarks[${reg}]"]`).value || 0;
      
      const attendance = document.querySelector(`input[name="attendance[${reg}]"]`).value || 0;
      const param = new URLSearchParams(window.location.search);
      const studentClass = param.get('studentClass');
      const section = param.get('section');
      const subject = param.get('subject');
      const academicYear = param.get('academicYear');
      const terminal = param.get('terminal');
      const name = document.querySelector(`input[name="name[${reg}]"]`).value;
      const roll = document.querySelector(`input[name="roll[${reg}]"]`).value;

   
      const gender = document.querySelector(`input[name="gender[${reg}]"]`).value;
      const passMarks = document.getElementById('passMarks').value;
      const practicalfullmarks = document.getElementById('practicalfullmarks').value;
      const theoryfullmarks = document.getElementById('fullMarks').value;

    const worksheekGrade = document.querySelectorAll(`select[name="worksheetGrades[${reg}][]"]`);
    let worksheetGrades = [];
    worksheekGrade.forEach((select)=>{
      worksheetGrades.push(select.value);
    });
      const totalWorksheet = document.getElementById('totalWorksheet').value || 0;    
      console.log(`Auto-saving data for reg: ${reg}, theorymarks: ${theorymarks}, attendance: ${attendance}, totalWorksheet: ${totalWorksheet}, worksheetGrades: ${worksheetGrades}, studentClass: ${studentClass}, section: ${section}, subject: ${subject}, academicYear: ${academicYear}, terminal: ${terminal}, name: ${name}, roll: ${roll}, gender: ${gender}, passMarks: ${passMarks}, practicalfullmarks: ${practicalfullmarks}, theoryfullmarks: ${theoryfullmarks}`);
      try {
        const response = await fetch(`/entryform?studentClass=${studentClass}&section=${section}&subject=${subject}&academicYear=${academicYear}&terminal=${terminal}`,{
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            reg,
            theorymarks,
           
            attendance,
            studentClass,
            section,
            subject,
            academicYear,
            terminal,
            name,
            roll,
            totalWorksheet,
            worksheetGrades,
            gender,
            passMarks,
            practicalfullmarks,
            theoryfullmarks,


          })
        });
        if (response.ok) {
               // Success: Transparent Light Blue
               el.style.backgroundColor = '#e0f2fe'; // Light blue
               el.style.borderColor = '#7dd3fc'; // Light blue border
               el.style.transition = 'background-color 0.3s ease';
            }
      } catch (err) {
        console.error(err);
      }
      saveTimers.delete(el);
    },1000);

    saveTimers.set(el, timer);
  }
 </script>

 <!-- script to create dynamic input box -->
  <script>
    totalWorksheetInput = document.getElementById('totalWorksheet');
    totalWorksheetInput.addEventListener('input',function(){
        const totalWorksheets = Number(totalWorksheetInput.value);
        const dataEntryRow = document.getElementById('dataEntryRow');
        const headerRow = document.getElementById('headerRow');
        console.log("headerRow:", headerRow.children.length);
        const ThToRemove =5
        while(headerRow.children.length > ThToRemove){
            headerRow.removeChild(headerRow.lastChild);
        }
        for(i=0;i<totalWorksheets;i++){
            const th = document.createElement('th');
            th.innerText = `Worksheet ${i+1} Marks`;
            headerRow.appendChild(th);
        }
        const studentData = <%- JSON.stringify(studentData) %>;
        studentData.forEach((student)=>{
            const reg = student.reg;
            const row = document.querySelector(`input[name="roll[${reg}]"]`).parentElement.parentElement;
            thToRemove = 7
            while(row.children.length > thToRemove){
                row.removeChild(row.lastChild);
            }
            for(j=0;j<totalWorksheets;j++){
                const td = document.createElement('td');
                const input = document.createElement('select');
                const option1 = document.createElement('option');
                option1.value = "Select Grade";
                option1.text = "Select Grade";
                option1.selected = true;
                option1.disabled = true;
                const option2 = document.createElement('option');
                option2.value = "A+";
                option2.text = "A+";
                const option3 = document.createElement('option');
                option3.value = "A";
                option3.text = "A";
                const option4 = document.createElement('option');
                option4.value = "B+";
                option4.text = "B+";
                const option5 = document.createElement('option');

                option5.value = "B";
                option5.text = "B";
                const option6 = document.createElement('option');
                option6.value = "C+";
                option6.text = "C+";
                const option7 = document.createElement('option');
                option7.value = "C";
                option7.text = "C";
                option8 = document.createElement('option');
                option8.value = "D";
                option8.text = "D";
                option9 = document.createElement('option');
                option9.value = "NG";
                option9.text = "NG";

                input.appendChild(option1);
                input.appendChild(option2); 
                input.appendChild(option3);
                input.appendChild(option4);
                input.appendChild(option5);
                input.appendChild(option6);
                input.appendChild(option7);
                input.appendChild(option8);
                input.appendChild(option9);

                input.name = `worksheetGrades[${reg}][]`;
                input.dataset.reg = reg;
                input.addEventListener('change',function(){
                    autoSave(input);
                });
                td.appendChild(input);
                row.appendChild(td);
            }
        });
        
    });
  </script>

  <!-- script to check max max exceeds -->
 <script>
  function checkMax(element)
  {
    const reg = element.dataset.reg;
    const maxMarks = element.dataset.max;
    if(Number(element.value) > Number (maxMarks))
    {
      const inputbox = element;
      element.style.backgroundColor = '#fee2e2'; // Light red
      element.style.borderColor = '#f87171'; // Red border
      element.style.transition = 'background-color 0.3s ease';
      element.focus();
      element.placeholder = 'Max Marks Exceeded';
      
      // Clear any pending autoSave timer
      if (typeof saveTimers !== 'undefined' && saveTimers.has(element)) {
          clearTimeout(saveTimers.get(element));
          saveTimers.delete(element);
      }

      return; // Exit if max marks exceeded
    }
    else
    {
      element.style.backgroundColor = '';
      element.style.borderColor = '';
       autoSave(element);
    }
    

   
    
    
  }
 </script>
</body>
</html>